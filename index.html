<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Gerenciador de Pedidos de Peças</title>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>
    <style>
        body {
            background-color: #121212;
            color: #e0e0e0;
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        h1 {
            margin: 20px 0;
            color: #00e676;
        }

        .container {
            width: 95%;
            max-width: 950px;
            display: flex;
            flex-direction: column;
            gap: 25px;
        }

        form, .controls {
            background: #1e1e1e;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px #00000055;
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            justify-content: center;
            align-items: center;
        }

        select, input {
            padding: 10px;
            border: none;
            border-radius: 4px;
            width: 200px;
            background-color: #2a2a2a;
            color: #fff;
        }

            select:focus, input:focus {
                outline: 2px solid #00e676;
            }

        button {
            background-color: #00c853;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s;
            font-weight: bold;
        }

            button:hover {
                background-color: #00e676;
            }

        .lista-container {
            width: 100%;
        }

        .lista {
            margin-top: 10px;
            width: 100%;
        }

        .item {
            background: #1e1e1e;
            border-radius: 6px;
            margin-bottom: 10px;
            padding: 12px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 0 5px #00000055;
        }

        .info {
            flex-grow: 1;
        }

        .codigo {
            color: #00e676;
            font-weight: bold;
        }

        .excluir {
            background-color: #d32f2f;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
        }

            .excluir:hover {
                background-color: #f44336;
            }

        .msg {
            color: #ffc107;
            font-size: 14px;
            height: 20px;
            text-align: center;
            width: 100%;
            font-weight: bold;
        }

            .msg.success {
                color: #00e676;
            }

        .checkbox-container, .checkbox-container-control {
            display: flex;
            align-items: center;
            gap: 10px;
        }

            .checkbox-container input[type="checkbox"], .checkbox-container-control input[type="checkbox"] {
                width: 20px;
                height: 20px;
                cursor: pointer;
            }

        .item.pedido-feito {
            background-color: #161616;
            border-left: 4px solid #d32f2f;
        }

            .item.pedido-feito .codigo {
                color: #B80C1F;
            }

        .lista-info {
            color: #E06921;
            font-weight: bold;
            font-size: 16px;
            height: 20px;
        }

        #toggleTodosBtn {
            background-color: #ff9800;
        }

            #toggleTodosBtn:hover {
                background-color: #fb8c00;
            }
    </style>
</head>
<body>
    <div class="container">
        <h1>Gerenciador de Pedidos de Peças</h1>

        <form id="form">
            <select id="marca" required><option value="">Selecione uma marca</option><option value="Makita">Makita</option><option value="DeWalt">DeWalt (Stanley, Black & Decker )</option><option value="Bosch">Bosch (Skil, Dremel)</option></select>
            <input id="codigo" placeholder="Código da peça" required />
            <input id="descricao" placeholder="Descrição" required />
            <input id="quantidade" placeholder="Qtd" type="number" min="1" required />
            <button type="submit">Adicionar Peça</button>
        </form>

        <div class="msg" id="msg"></div>

        <div class="controls">
            <select id="filtroMarca"><option value="">Filtrar por Marca (Todas)</option><option value="Makita">Makita</option><option value="DeWalt">DeWalt (Stanley, Black & Decker)</option><option value="Bosch">Bosch (Skil, Dremel)</option></select>
            <div class="checkbox-container-control">
                <input type="checkbox" id="mostrarFeitos" />
                <label for="mostrarFeitos">Mostrar apenas pedidos feitos</label>
            </div>
            <button id="toggleTodosBtn">Marcar Visíveis como Feito</button>
        </div>

        <div class="lista-container">
            <div class="lista-info" id="lista-contador"></div>
            <div class="lista" id="lista"></div>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyB4M2NG0BdDyLyz5X_vFjnsYXbTy_j_92M",
            authDomain: "pedidos-pecas.firebaseapp.com",
            projectId: "pedidos-pecas",
            storageBucket: "pedidos-pecas.firebasestorage.app",
            messagingSenderId: "284648024693",
            appId: "1:284648024693:web:155df24699e97052ae263c"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const pedidosRef = db.collection("itens_semana");

        const form = document.getElementById("form");
        const lista = document.getElementById("lista");
        const msg = document.getElementById("msg");
        const filtroMarca = document.getElementById("filtroMarca");
        const mostrarFeitos = document.getElementById("mostrarFeitos");
        const toggleTodosBtn = document.getElementById("toggleTodosBtn");

        let currentVisibleItems = [];

        function getTenDaysAgo() {
            const d = new Date();
            d.setDate(d.getDate() - 15);
            d.setHours(0, 0, 0, 0);
            return d;
        }

        async function verificarEExcluirPedidosAntigos() {
            console.log("Verificando pedidos antigos para exclusão...");
            const dezDiasAtras = getTenDaysAgo();
            const timestampDezDiasAtras = firebase.firestore.Timestamp.fromDate(dezDiasAtras);

            try {
                const snapshot = await pedidosRef
                    .where("pedidoFeito", "==", true)
                    .where("dataPedido", "<", timestampDezDiasAtras)
                    .get();

                if (snapshot.empty) return;

                const batch = db.batch();
                snapshot.forEach(doc => batch.delete(doc.ref));
                await batch.commit();
                console.log(`Foram excluídos ${snapshot.size} itens antigos.`);
            } catch (error) {
                console.error("Erro ao excluir pedidos antigos:", error);
                setMsg("Erro no ciclo de exclusão. Verifique o console.", "error");
            }
        }

        function renderLista(snapshot) {
            lista.innerHTML = "";
            const marcaFiltrada = filtroMarca.value;

            let allItems = [];
            snapshot.forEach(doc => allItems.push({ id: doc.id, ...doc.data() }));

            currentVisibleItems = allItems.filter(item => !marcaFiltrada || item.marca === marcaFiltrada);

            document.getElementById("lista-contador").textContent = `Exibindo ${currentVisibleItems.length} item(ns).`;
            updateToggleAllButton();

            currentVisibleItems.sort((a, b) => a.marca.localeCompare(b.marca) || a.codigo.localeCompare(b.codigo));

            currentVisibleItems.forEach(item => {
                const div = document.createElement("div");
                div.className = `item ${item.pedidoFeito ? 'pedido-feito' : ''}`;
                const dataCriacao = item.criadoEm ? item.criadoEm.toDate().toLocaleDateString('pt-BR') : 'N/A';
                const dataPedido = item.dataPedido ? ` | Pedido em: ${item.dataPedido.toDate().toLocaleDateString('pt-BR')}` : '';

                div.innerHTML = `
                        <div class="info">
                            <span class="codigo">${item.codigo}</span> - ${item.descricao}

                            Marca: ${item.marca} | Qtd: ${item.quantidade} | Adicionado em: ${dataCriacao}${dataPedido}
                        </div>
                        <div class="checkbox-container">
                            <label for="pedido-${item.id}">Pedido Feito</label>
                            <input type="checkbox" id="pedido-${item.id}" data-id="${item.id}" ${item.pedidoFeito ? 'checked' : ''} />
                        </div>
                        <button class="excluir" data-id="${item.id}">Excluir</button>
                    `;
                lista.appendChild(div);
            });

            addEventListenersToLista();
        }

        function addEventListenersToLista() {
            document.querySelectorAll(".excluir").forEach(btn => {
                btn.onclick = async (e) => {
                    const id = e.target.getAttribute("data-id");
                    if (confirm("Tem certeza que deseja excluir esta peça permanentemente?")) {
                        await pedidosRef.doc(id).delete();
                    }
                };
            });

            document.querySelectorAll(".checkbox-container input[type='checkbox']").forEach(checkbox => {
                checkbox.onchange = async (e) => {
                    const id = e.target.getAttribute("data-id");
                    const isChecked = e.target.checked;
                    await pedidosRef.doc(id).update({
                        pedidoFeito: isChecked,
                        dataPedido: isChecked ? firebase.firestore.Timestamp.fromDate(new Date()) : firebase.firestore.FieldValue.delete()
                    });
                };
            });
        }

        let unsubscribe;
        function setupListener() {
            if (unsubscribe) unsubscribe();
            let query = pedidosRef.where("pedidoFeito", "==", mostrarFeitos.checked);
            unsubscribe = query.onSnapshot(renderLista, error => {
                console.error("Erro ao buscar pedidos:", error);
                setMsg("Erro ao carregar a lista. Verifique os índices do Firestore.", "error");
            });
        }

        function setMsg(text, type = 'info', duration = 4000) {
            msg.textContent = text;
            msg.className = `msg ${type === 'success' ? 'success' : ''}`;
            if (duration) {
                setTimeout(() => msg.textContent = "", duration);
            }
        }

        form.addEventListener("submit", async e => {
            e.preventDefault();
            const marca = form.marca.value.trim();
            const codigo = form.codigo.value.trim().toUpperCase();
            const descricao = form.descricao.value.trim();
            const quantidade = parseInt(form.quantidade.value);

            if (!marca || !codigo || !descricao || !quantidade) {
                setMsg("Preencha todos os campos!");
                return;
            }

            // --- LÓGICA DE VALIDAÇÃO ATUALIZADA ---
            const snapshot = await pedidosRef.where("codigo", "==", codigo).get();

            if (!snapshot.empty) {
                const doc = snapshot.docs[0];
                const itemExistente = doc.data();

                if (itemExistente.pedidoFeito) {
                    // 1. Bloqueia se o item já foi pedido e ainda está no ciclo de 10 dias
                    setMsg(`⚠️ Este item já foi pedido e aguarda o ciclo de 10 dias para ser excluído.`);
                } else {
                    // 2. Pergunta se quer atualizar a quantidade de um item pendente
                    if (confirm(`Este item já está na lista de pendentes. Deseja somar a nova quantidade de ${quantidade}?`)) {
                        await doc.ref.update({
                            quantidade: firebase.firestore.FieldValue.increment(quantidade),
                            descricao: descricao,
                            marca: marca
                        });
                        setMsg("✅ Quantidade atualizada com sucesso!", "success");
                        form.reset();
                        form.codigo.focus();
                    }
                }
                return; // Encerra a função aqui
            }

            // 3. Se passou por todas as validações, adiciona o novo item
            await pedidosRef.add({
                marca, codigo, descricao, quantidade,
                criadoEm: firebase.firestore.Timestamp.fromDate(new Date()),
                pedidoFeito: false,
            });
            setMsg("✅ Peça adicionada com sucesso!", "success");

            form.reset();
            form.codigo.focus();
        });

        function updateToggleAllButton() {
            if (currentVisibleItems.length === 0) {
                toggleTodosBtn.style.display = 'none';
                return;
            }
            toggleTodosBtn.style.display = 'inline-block';

            const allChecked = currentVisibleItems.every(item => item.pedidoFeito);
            toggleTodosBtn.textContent = allChecked ? "Desmarcar Visíveis" : "Marcar Visíveis como Feito";
            toggleTodosBtn.onclick = () => toggleAll(!allChecked);
        }

        async function toggleAll(marcarComoFeito) {
            if (currentVisibleItems.length === 0) return;
            const actionText = marcarComoFeito ? "marcar" : "desmarcar";
            if (!confirm(`Deseja ${actionText} ${currentVisibleItems.length} item(ns)?`)) return;

            const batch = db.batch();
            const updateData = {
                pedidoFeito: marcarComoFeito,
                dataPedido: marcarComoFeito ? firebase.firestore.Timestamp.fromDate(new Date()) : firebase.firestore.FieldValue.delete()
            };
            currentVisibleItems.forEach(item => batch.update(pedidosRef.doc(item.id), updateData));

            try {
                await batch.commit();
                setMsg(`✅ ${currentVisibleItems.length} itens foram atualizados.`, "success");
            } catch (error) {
                console.error(`Erro ao ${actionText} todos:`, error);
                setMsg("Ocorreu um erro na operação em lote.", "error");
            }
        }

        // --- INICIALIZAÇÃO ---
        mostrarFeitos.checked = false; // Garante que a lista de pendentes seja exibida ao iniciar
        filtroMarca.addEventListener("change", setupListener);
        mostrarFeitos.addEventListener("change", setupListener);

        verificarEExcluirPedidosAntigos().then(() => {
            setupListener();
        });
    </script>
</body>
</html>
