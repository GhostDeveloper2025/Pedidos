<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Gerenciador de Pedidos de Peças</title>
    <!-- Usando a versão 9 do Firebase SDK para melhor performance e recursos -->
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>
    <style>
        body {
            background-color: #121212;
            color: #e0e0e0;
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        h1 {
            margin: 20px 0;
            color: #00e676;
        }

        .controls {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            align-items: center;
        }

        form {
            background: #1e1e1e;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px #00000055;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            max-width: 900px;
        }

        select, input {
            padding: 10px;
            border: none;
            border-radius: 4px;
            width: 200px;
            background-color: #2a2a2a;
            color: #fff;
        }

            select:focus, input:focus {
                outline: 2px solid #00e676;
            }

        button {
            background-color: #00c853;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s;
            font-weight: bold;
        }

            button:hover {
                background-color: #00e676;
            }

        .lista {
            margin-top: 30px;
            width: 90%;
            max-width: 900px;
        }

        .item {
            background: #1e1e1e;
            border-radius: 6px;
            margin-bottom: 10px;
            padding: 12px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 0 5px #00000055;
        }

        .info {
            flex-grow: 1;
        }

        .codigo {
            color: #00e676;
            font-weight: bold;
        }

        .excluir {
            background-color: #d32f2f;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
        }

            .excluir:hover {
                background-color: #f44336;
            }

        .msg {
            margin-top: 10px;
            color: #00e676;
            font-size: 14px;
            height: 18px;
        }

        .checkbox-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }

            .checkbox-container input[type="checkbox"] {
                width: 20px;
                height: 20px;
                cursor: pointer;
            }

        .item.pedido-feito {
            opacity: 0.5;
            text-decoration: line-through;
        }
    </style>
</head>
<body>
    <h1>Gerenciador de Pedidos de Peças</h1>

    <form id="form">
        <select id="marca" required>
            <option value="">Selecione uma marca</option>
            <option value="Makita">Makita</option>
            <option value="DeWalt">DeWalt (Stanley, Black & Decker)</option>
            <option value="Bosch">Bosch (Skil, Dremel)</option>
        </select>

        <input id="codigo" placeholder="Código da peça" required />
        <input id="descricao" placeholder="Descrição" required />
        <input id="quantidade" placeholder="Qtd" type="number" min="1" required />
        <button type="submit">Adicionar Peça</button>
    </form>

    <div class="msg" id="msg"></div>

    <div class="controls">
        <select id="filtroMarca">
            <option value="">Filtrar por Marca (Todas)</option>
            <option value="Makita">Makita</option>
            <option value="DeWalt">DeWalt (Stanley, Black & Decker)</option>
            <option value="Bosch">Bosch (Skil, Dremel)</option>
        </select>
    </div>

    <div class="lista" id="lista"></div>

    <script>
        // ⚠️ Substitua pelos seus dados do Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyB4M2NG0BdDyLyz5X_vFjnsYXbTy_j_92M",
            authDomain: "pedidos-pecas.firebaseapp.com",
            projectId: "pedidos-pecas",
            storageBucket: "pedidos-pecas.firebasestorage.app",
            messagingSenderId: "284648024693",
            appId: "1:284648024693:web:155df24699e97052ae263c"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        // Usaremos a coleção 'itens_semana' conforme a imagem, mas a lógica será aplicada
        const pedidosRef = db.collection("itens_semana");

        const form = document.getElementById("form");
        const lista = document.getElementById("lista");
        const msg = document.getElementById("msg");
        const filtroMarca = document.getElementById("filtroMarca");

        // --- Funções de Data e Semana ---

        // Retorna a data de início da semana (segunda-feira) para o controle de ciclo
        function getStartOfWeek(date) {
            const d = new Date(date);
            const day = d.getDay(); // 0 = Domingo, 1 = Segunda, ..., 6 = Sábado
            const diff = d.getDate() - day + (day === 0 ? -6 : 1); // Ajusta para a Segunda-feira
            d.setDate(diff);
            d.setHours(0, 0, 0, 0);
            return d;
        }

        // Retorna a data de 10 dias atrás para o ciclo de repetição
        function getTenDaysAgo() {
            const d = new Date();
            d.setDate(d.getDate() - 10);
            return d;
        }

        // --- Renderização da Lista ---

        function renderLista(snapshot) {
            lista.innerHTML = "";
            let pedidosDaSemana = [];
            const marcaFiltrada = filtroMarca.value;

            snapshot.forEach(doc => {
                const item = doc.data();
                // Filtro por marca
                if (marcaFiltrada && item.marca !== marcaFiltrada) {
                    return;
                }
                pedidosDaSemana.push({ id: doc.id, ...item });
            });

            // Ordenar por marca para facilitar a visualização do filtro
            pedidosDaSemana.sort((a, b) => a.marca.localeCompare(b.marca));

            pedidosDaSemana.forEach(item => {
                const div = document.createElement("div");
                div.className = `item ${item.pedidoFeito ? 'pedido-feito' : ''}`;

                // Formatar a data de criação para exibição
                const dataCriacao = item.criadoEm ? item.criadoEm.toDate().toLocaleDateString('pt-BR') : 'N/A';

                div.innerHTML = `
                        <div class="info">
                            <span class="codigo">${item.codigo}</span> - ${item.descricao}<br>
                            Marca: ${item.marca} | Qtd: ${item.quantidade} | Adicionado em: ${dataCriacao}
                        </div>
                        <div class="checkbox-container">
                            <label for="pedido-${item.id}">Pedido Feito</label>
                            <input type="checkbox" id="pedido-${item.id}" data-id="${item.id}" ${item.pedidoFeito ? 'checked' : ''} />
                        </div>
                        <button class="excluir" data-id="${item.id}">Excluir</button>
                    `;
                lista.appendChild(div);
            });

            // Adicionar listeners para exclusão
            document.querySelectorAll(".excluir").forEach(btn => {
                btn.addEventListener("click", async e => {
                    const id = e.target.getAttribute("data-id");
                    if (confirm("Tem certeza que deseja excluir esta peça?")) {
                        await pedidosRef.doc(id).delete();
                    }
                });
            });

            // Adicionar listeners para o checkbox de "Pedido Feito"
            document.querySelectorAll(".checkbox-container input[type='checkbox']").forEach(checkbox => {
                checkbox.addEventListener("change", async e => {
                    const id = e.target.getAttribute("data-id");
                    const pedidoFeito = e.target.checked;
                    const updateData = {
                        pedidoFeito: pedidoFeito,
                        dataPedido: pedidoFeito ? firebase.firestore.Timestamp.fromDate(new Date()) : firebase.firestore.FieldValue.delete()
                    };
                    await pedidosRef.doc(id).update(updateData);
                });
            });
        }

        // --- Listener do Firestore com Filtro de Ciclo ---

        let unsubscribe;

        function setupListener() {
            // Filtra:
            // 1. Apenas itens que NÃO foram marcados como "pedidoFeito"
            // 2. OU itens que foram marcados como "pedidoFeito" há mais de 10 dias (para poderem ser pedidos novamente)
            // Infelizmente, o Firestore não permite consultas OR complexas ou NOT, então faremos a filtragem principal no cliente.
            // A consulta principal será para todos os itens que não foram pedidos ou que foram pedidos há mais de 10 dias.

            // Para a lógica de "itens que foram pedidos há mais de 10 dias", precisamos de uma consulta de intervalo.
            // Vamos simplificar a consulta inicial para pegar todos os itens que NÃO foram pedidos.
            // A lógica de 10 dias será aplicada no momento da adição (para evitar repetição) e na renderização (para mostrar/ocultar).

            // Consulta principal: Itens que NÃO foram marcados como pedidos.
            // Como a lógica de ciclo é complexa, vamos buscar todos os itens e filtrar no cliente.
            // Isso é aceitável para um volume pequeno de dados.
            // Se o volume for grande, a regra de segurança do Firestore deve ser usada para limitar o acesso.

            // Para a lógica de ciclo semanal, vamos buscar todos os itens.
            // A lógica de não-repetição será aplicada no momento da adição.

            // Para a visualização, vamos buscar todos os itens e filtrar no cliente.
            // A consulta será ordenada por marca e código para facilitar a visualização.
            const query = pedidosRef.orderBy("marca").orderBy("codigo");

            if (unsubscribe) {
                unsubscribe(); // Remove o listener anterior
            }

            unsubscribe = query.onSnapshot(renderLista, error => {
                console.error("Erro ao buscar pedidos:", error);
                msg.textContent = "Erro ao carregar a lista de pedidos.";
            });
        }

        // Inicializa o listener
        setupListener();

        // Adiciona listener para o filtro de marca
        filtroMarca.addEventListener("change", setupListener);


        // --- Lógica de Adição de Pedido (com validação de não-repetição) ---

        form.addEventListener("submit", async e => {
            e.preventDefault();

            const marca = form.marca.value.trim();
            const codigo = form.codigo.value.trim().toUpperCase();
            const descricao = form.descricao.value.trim();
            const quantidade = parseInt(form.quantidade.value);

            if (!marca || !codigo || !descricao || !quantidade) {
                msg.textContent = "Preencha todos os campos corretamente!";
                return;
            }

            // 1. Validação de não-repetição na lista ATUAL (mesmo código)
            const duplicadoAtual = await pedidosRef.where("codigo", "==", codigo).get();
            if (!duplicadoAtual.empty) {
                // Verificar se o item duplicado já foi pedido há menos de 10 dias
                const itemExistente = duplicadoAtual.docs[0].data();

                if (itemExistente.pedidoFeito) {
                    const dataPedido = itemExistente.dataPedido.toDate();
                    const dezDiasAtras = getTenDaysAgo();

                    if (dataPedido > dezDiasAtras) {
                        // Foi pedido há menos de 10 dias, não pode ser adicionado
                        msg.textContent = `⚠️ Este código foi pedido em ${dataPedido.toLocaleDateString('pt-BR')} e só poderá ser adicionado novamente após ${new Date(dataPedido.getTime() + 10 * 24 * 60 * 60 * 1000).toLocaleDateString('pt-BR')}.`;
                        return;
                    }
                    // Se foi pedido há mais de 10 dias, pode ser adicionado novamente.
                    // Neste caso, vamos apenas atualizar a quantidade do item existente.
                    await pedidosRef.doc(duplicadoAtual.docs[0].id).update({
                        quantidade: firebase.firestore.FieldValue.increment(quantidade),
                        // Remove o status de pedido feito para entrar na lista da semana
                        pedidoFeito: false,
                        dataPedido: firebase.firestore.FieldValue.delete(),
                        // Atualiza a data de criação para a data atual
                        criadoEm: firebase.firestore.Timestamp.fromDate(new Date())
                    });
                    msg.textContent = "✅ Quantidade do item existente atualizada e re-adicionado à lista de pedidos!";
                    form.reset();
                    setTimeout(() => msg.textContent = "", 4000);
                    return;

                } else {
                    // Item duplicado e NÃO foi pedido.
                    // A lógica do usuário é: "o produto nao pode se repetir e tem que ter um ciclo"
                    // Vamos considerar que se ele já está na lista da semana, ele não pode ser adicionado novamente.
                    msg.textContent = "⚠️ Este código já está na lista de pedidos desta semana!";
                    return;
                }
            }

            // 2. Validação de ciclo semanal (adicionar apenas se for segunda-feira ou se a data de criação for da semana atual)
            // O usuário quer que pedidos de terça em diante fiquem para a próxima semana.
            // Isso implica que a lista ATUAL é a lista da semana que começou na última segunda-feira.
            // Para simplificar, vamos usar a regra: se for segunda-feira, a lista é zerada (ou a data de ciclo é atualizada).
            // Como não temos um backend para gerenciar o ciclo, vamos focar na regra de não-repetição e no status de pedido.
            // A regra de "terça em diante fica para a próxima semana" é mais complexa e sugere um sistema de "lista atual" e "próxima lista".
            // Para manter a simplicidade do código front-end, vamos focar na regra de não-repetição e 10 dias.

            // Para a regra de "terça em diante", o usuário pode simplesmente não adicionar o item na lista 'itens_semana'
            // e usar uma coleção 'itens_proxima_semana' ou adicionar um campo 'semana' com a data da próxima segunda-feira.
            // Vamos manter a coleção única e adicionar o campo 'semanaInicio' para controle.

            const hoje = new Date();
            const diaDaSemana = hoje.getDay(); // 0 = Domingo, 1 = Segunda

            let semanaInicio;
            if (diaDaSemana === 1) { // Segunda-feira
                semanaInicio = getStartOfWeek(hoje);
            } else if (diaDaSemana >= 2) { // Terça a Domingo
                // Se for de terça em diante, o item é para a próxima semana.
                // A próxima semana começa na próxima segunda-feira.
                const proximaSegunda = new Date(hoje);
                proximaSegunda.setDate(hoje.getDate() + (8 - diaDaSemana)); // (8 - diaDaSemana) calcula os dias até a próxima segunda
                semanaInicio = getStartOfWeek(proximaSegunda);
            } else { // Domingo (0)
                // Domingo é considerado como parte da semana que está terminando.
                semanaInicio = getStartOfWeek(hoje);
            }

            // Adicionar o novo pedido
            await pedidosRef.add({
                marca,
                codigo,
                descricao,
                quantidade,
                criadoEm: firebase.firestore.Timestamp.fromDate(hoje),
                semanaInicio: firebase.firestore.Timestamp.fromDate(semanaInicio), // Para controle de ciclo
                pedidoFeito: false, // Novo item nunca foi pedido
            });

            msg.textContent = "✅ Peça adicionada com sucesso!";
            form.reset();
            setTimeout(() => msg.textContent = "", 2000);
        });
    </script>
</body>
</html>