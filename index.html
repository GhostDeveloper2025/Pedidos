<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Gerenciador de Pedidos de Peças</title>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>
    <style>
        body {
            background-color: #121212;
            color: #e0e0e0;
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        h1 {
            margin: 20px 0;
            color: #00e676;
        }

        .controls {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            align-items: center;
        }

        form {
            background: #1e1e1e;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px #00000055;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            max-width: 900px;
        }

        select, input {
            padding: 10px;
            border: none;
            border-radius: 4px;
            width: 200px;
            background-color: #2a2a2a;
            color: #fff;
        }

            select:focus, input:focus {
                outline: 2px solid #00e676;
            }

        button {
            background-color: #00c853;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s;
            font-weight: bold;
        }

            button:hover {
                background-color: #00e676;
            }

        .lista {
            margin-top: 30px;
            width: 90%;
            max-width: 900px;
        }

        .item {
            background: #1e1e1e;
            border-radius: 6px;
            margin-bottom: 10px;
            padding: 12px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 0 5px #00000055;
        }

        .info {
            flex-grow: 1;
        }

        .codigo {
            color: #00e676;
            font-weight: bold;
        }

        .excluir {
            background-color: #d32f2f;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
        }

            .excluir:hover {
                background-color: #f44336;
            }

        .msg {
            margin-top: 10px;
            color: #00e676;
            font-size: 14px;
            height: 18px;
        }

        .checkbox-container, .checkbox-container-control {
            display: flex;
            align-items: center;
            gap: 10px;
        }

            .checkbox-container input[type="checkbox"],
            .checkbox-container-control input[type="checkbox"] {
                width: 20px;
                height: 20px;
                cursor: pointer;
            }
        /* Estilo para itens marcados como "Pedido Feito" */
        /*.item.pedido-feito {
            opacity: 0.5;
            text-decoration: line-through;
        }*/
        /* Esconde itens "Pedido Feito" por padrão (quando o checkbox de controle não está marcado) */
        /*.item.pedido-feito.hide-feito {
                display: none;
            }*/

        /* Estilo para itens marcados como "Pedido Feito" */
        .item.pedido-feito {
            background-color: #161616; /* Um fundo um pouco mais escuro */
            border-left: 4px solid #d32f2f; /* Borda vermelha para indicar "feito" */
            /* Removemos os estilos antigos */
            /* opacity: 0.5; */
            /* text-decoration: line-through; */
        }

            /* Opcional: Também podemos deixar o código verde mais apagado */
            .item.pedido-feito .codigo {
                color: #B80C1F; /* Muda o código de verde para cinza */
            }

        /* style pra mostrar contagem lista*/
        .lista-info {
            width: 90%;
            max-width: 900px;
            margin-top: 20px; /* Espaço acima */
            margin-bottom: -20px; /* Puxa a lista para perto */
            color: #E06921; /* Cor verde para destacar */
            font-weight: bold;
            font-size: 16px;
            height: 20px; /* Altura fixa para não "pular" */
        }
    </style>
</head>
<body>
    <h1>Gerenciador de Pedidos de Peças</h1>

    <form id="form">
        <select id="marca" required>
            <option value="">Selecione uma marca</option>
            <option value="Makita">Makita</option>
            <option value="DeWalt">DeWalt (Stanley, Black & Decker)</option>
            <option value="Bosch">Bosch (Skil, Dremel)</option>
        </select>

        <input id="codigo" placeholder="Código da peça" required />
        <input id="descricao" placeholder="Descrição" required />
        <input id="quantidade" placeholder="Qtd" type="number" min="1" required />
        <button type="submit">Adicionar Peça</button>
    </form>

    <div class="msg" id="msg"></div>

    <div class="controls">
        <select id="filtroMarca">
            <option value="">Filtrar por Marca (Todas)</option>
            <option value="Makita">Makita</option>
            <option value="DeWalt">DeWalt (Stanley, Black & Decker)</option>
            <option value="Bosch">Bosch (Skil, Dremel)</option>
        </select>

        <div class="checkbox-container-control">
            <input type="checkbox" id="mostrarFeitos" />
            <label for="mostrarFeitos">Mostrar pedidos já feitos</label>
        </div>
    </div>
    
    <div class="lista-info" id="lista-contador"></div>

    <div class="lista" id="lista"></div>

    <script>
        // ⚠️ Substitua pelos seus dados do Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyB4M2NG0BdDyLyz5X_vFjnsYXbTy_j_92M",
            authDomain: "pedidos-pecas.firebaseapp.com",
            projectId: "pedidos-pecas",
            storageBucket: "pedidos-pecas.firebasestorage.app",
            messagingSenderId: "284648024693",
            appId: "1:284648024693:web:155df24699e97052ae263c"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const pedidosRef = db.collection("itens_semana");

        const form = document.getElementById("form");
        const lista = document.getElementById("lista");
        const msg = document.getElementById("msg");
        const filtroMarca = document.getElementById("filtroMarca");
        const mostrarFeitos = document.getElementById("mostrarFeitos"); // Pega o novo checkbox

        // --- Funções de Data e Semana ---

        // Retorna a data de 10 dias atrás para o ciclo de repetição
        function getTenDaysAgo() {
            const d = new Date();
            d.setDate(d.getDate() - 10);
            d.setHours(0, 0, 0, 0); // Zera o horário para comparar
            return d;
        }

        // --- LÓGICA DE ATUALIZAÇÃO DE 10 DIAS ---

        /**
         * Verifica itens pedidos há mais de 10 dias e os "desmarca" (pedidoFeito: false).
         * Isso permite que eles sejam pedidos novamente.
         * Roda uma vez quando a página é carregada.
         */
        async function verificarEAtualizarPedidosAntigos() {
            console.log("Verificando pedidos antigos (mais de 10 dias)...");
            const dezDiasAtras = getTenDaysAgo();
            const timestampDezDiasAtras = firebase.firestore.Timestamp.fromDate(dezDiasAtras);

            // Consulta por itens que foram pedidos E cuja data do pedido é anterior a 10 dias atrás
            // ⚠️ ISSO EXIGE UM ÍNDICE NO FIRESTORE: (pedidoFeito, dataPedido)
            try {
                const snapshot = await pedidosRef
                    .where("pedidoFeito", "==", true)
                    .where("dataPedido", "<", timestampDezDiasAtras)
                    .get();

                if (snapshot.empty) {
                    console.log("Nenhum pedido antigo para atualizar.");
                    return;
                }

                // Usamos um Batch para atualizar todos de uma vez (mais eficiente)
                const batch = db.batch();
                snapshot.forEach(doc => {
                    console.log(`Atualizando item ${doc.id} (código ${doc.data().codigo}) para 'pedidoFeito: false'`);
                    batch.update(doc.ref, {
                        pedidoFeito: false,
                        dataPedido: firebase.firestore.FieldValue.delete() // Remove a data do pedido
                    });
                });

                await batch.commit();
                console.log(`Foram atualizados ${snapshot.size} itens.`);

            } catch (error) {
                console.error("Erro ao verificar pedidos antigos:", error);
                msg.textContent = "Erro ao atualizar ciclo de 10 dias. Verifique o console e os índices do Firestore.";
            }
        }


        // --- Renderização da Lista ---

        function renderLista(snapshot) {
            lista.innerHTML = "";
            let pedidosDaSemana = [];
            const marcaFiltrada = filtroMarca.value;
            const verFeitos = mostrarFeitos.checked; // Verifica o estado do novo checkbox

            //snapshot.forEach(doc => {
            //    const item = doc.data();
            //    // Filtro por marca (se houver)
            //    if (marcaFiltrada && item.marca !== marcaFiltrada) {
            //        return;
            //    }
            //    pedidosDaSemana.push({ id: doc.id, ...item });

            snapshot.forEach(doc => {
                const item = doc.data();
                // Filtro por marca (se houver)
                if (marcaFiltrada && item.marca !== marcaFiltrada) {
                    return;
                }
                pedidosDaSemana.push({ id: doc.id, ...item });
            });
            //
            // --- NOVO CÓDIGO DO CONTADOR ---
            // Pega o elemento do contador
            const contadorElement = document.getElementById("lista-contador");
            const totalItens = pedidosDaSemana.length;

            // Atualiza o texto com base no número de itens
            if (totalItens === 0) {
                contadorElement.textContent = "Nenhum item para exibir.";
            } else if (totalItens === 1) {
                contadorElement.textContent = "Exibindo 1 item.";
            } else {
                contadorElement.textContent = `Exibindo ${totalItens} itens.`;
            }

            //
            // Ordenar por marca para facilitar a visualização
            pedidosDaSemana.sort((a, b) => a.marca.localeCompare(b.marca));

            pedidosDaSemana.forEach(item => {
                const div = document.createElement("div");

                let classes = "item";
                if (item.pedidoFeito) {
                    classes += " pedido-feito";
                    if (!verFeitos) {
                        // Adiciona classe para esconder se não quisermos ver os feitos
                        classes += " hide-feito";
                    }
                }
                div.className = classes;


                // Formatar a data de criação para exibição
                const dataCriacao = item.criadoEm ? item.criadoEm.toDate().toLocaleDateString('pt-BR') : 'N/A';

                div.innerHTML = `
                                    <div class="info">
                                        <span class="codigo">${item.codigo}</span> - ${item.descricao}<br>
                                        Marca: ${item.marca} | Qtd: ${item.quantidade} | Adicionado em: ${dataCriacao}
                                    </div>
                                    <div class="checkbox-container">
                                        <label for="pedido-${item.id}">Pedido Feito</label>
                                        <input type="checkbox" id="pedido-${item.id}" data-id="${item.id}" ${item.pedidoFeito ? 'checked' : ''} />
                                    </div>
                                    <button class="excluir" data-id="${item.id}">Excluir</button>
                                `;
                lista.appendChild(div);
            });

            // Adicionar listeners para exclusão
            document.querySelectorAll(".excluir").forEach(btn => {
                btn.addEventListener("click", async e => {
                    const id = e.target.getAttribute("data-id");
                    if (confirm("Tem certeza que deseja excluir esta peça?")) {
                        await pedidosRef.doc(id).delete();
                    }
                });
            });

            // Adicionar listeners para o checkbox de "Pedido Feito"
            document.querySelectorAll(".checkbox-container input[type='checkbox']").forEach(checkbox => {
                checkbox.addEventListener("change", async e => {
                    const id = e.target.getAttribute("data-id");
                    const pedidoFeito = e.target.checked;
                    const updateData = {
                        pedidoFeito: pedidoFeito,
                        // Se marcou, salva a data. Se desmarcou, apaga a data.
                        dataPedido: pedidoFeito ? firebase.firestore.Timestamp.fromDate(new Date()) : firebase.firestore.FieldValue.delete()
                    };
                    await pedidosRef.doc(id).update(updateData);
                    // O listener onSnapshot vai recarregar a lista automaticamente
                });
            });
        }

        // --- Listener do Firestore com Filtro de Ciclo ---

        let unsubscribe;

        function setupListener() {
            // Se já houver um listener, remove
            if (unsubscribe) {
                unsubscribe();
            }

            // Pega o estado dos filtros
            const verFeitos = mostrarFeitos.checked;

            let query;

            if (verFeitos) {
                // Se o usuário QUER VER pedidos feitos, mostramos TODOS
                // (a filtragem de marca será feita no renderLista)
                query = pedidosRef.orderBy("marca").orderBy("codigo");
            } else {
                // Se o usuário NÃO quer ver pedidos feitos (visão padrão),
                // mostramos APENAS os que NÃO foram feitos.
                // ⚠️ ISSO EXIGE UM ÍNDICE NO FIRESTORE: (pedidoFeito, marca)
                query = pedidosRef
                    .where("pedidoFeito", "==", false)
                    .orderBy("marca")
                    .orderBy("codigo");
            }

            // Cria o novo listener
            unsubscribe = query.onSnapshot(renderLista, error => {
                console.error("Erro ao buscar pedidos:", error);
                msg.textContent = "Erro ao carregar a lista. Verifique o console e os índices do Firestore.";
            });
        }

        // --- Lógica de Adição de Pedido (com validação de não-repetição) ---

        form.addEventListener("submit", async e => {
            e.preventDefault();

            const marca = form.marca.value.trim();
            const codigo = form.codigo.value.trim().toUpperCase();
            const descricao = form.descricao.value.trim();
            const quantidade = parseInt(form.quantidade.value);

            if (!marca || !codigo || !descricao || !quantidade) {
                msg.textContent = "Preencha todos os campos corretamente!";
                return;
            }

            // 1. Validação de não-repetição
            const duplicadoAtual = await pedidosRef.where("codigo", "==", codigo).get();

            if (!duplicadoAtual.empty) {
                // Se encontrou um item com o mesmo código
                const itemExistente = duplicadoAtual.docs[0].data();
                const docId = duplicadoAtual.docs[0].id;

                if (itemExistente.pedidoFeito) {
                    // O item existe, mas já foi pedido.
                    // A função verificarEAtualizarPedidosAntigos() já deve ter limpado se tiver > 10 dias.
                    // Mas vamos checar de novo por segurança.
                    const dataPedido = itemExistente.dataPedido.toDate();
                    const dezDiasAtras = getTenDaysAgo();

                    if (dataPedido > dezDiasAtras) {
                        // Foi pedido há MENOS de 10 dias, não pode ser adicionado
                        msg.textContent = `⚠️ Este código foi pedido em ${dataPedido.toLocaleDateString('pt-BR')} e só poderá ser adicionado novamente após ${new Date(dataPedido.getTime() + 10 * 24 * 60 * 60 * 1000).toLocaleDateString('pt-BR')}.`;
                        return;
                    }

                    // Se chegou aqui, foi pedido há MAIS de 10 dias (ou a data foi limpa)
                    // Vamos reativar o item na lista de pedidos
                    await pedidosRef.doc(docId).update({
                        quantidade: firebase.firestore.FieldValue.increment(quantidade), // Soma a quantidade
                        descricao: descricao, // Atualiza a descrição
                        marca: marca, // Atualiza a marca
                        pedidoFeito: false, // Reativa na lista de pendentes
                        dataPedido: firebase.firestore.FieldValue.delete(),
                        criadoEm: firebase.firestore.Timestamp.fromDate(new Date()) // Atualiza a data de "adição"
                    });

                    msg.textContent = "✅ Item re-adicionado à lista de pedidos com quantidade atualizada!";

                } else {
                    // Item duplicado e NÃO foi pedido (pedidoFeito == false)
                    msg.textContent = "⚠️ Este código já está na lista de pedidos desta semana!";
                    return;
                }

            } else {
                // 2. Se não há duplicado, adicionar o novo pedido
                await pedidosRef.add({
                    marca,
                    codigo,
                    descricao,
                    quantidade,
                    criadoEm: firebase.firestore.Timestamp.fromDate(new Date()),
                    pedidoFeito: false, // Novo item entra como pendente
                });

                msg.textContent = "✅ Peça adicionada com sucesso!";
            }


            form.reset();
            setTimeout(() => msg.textContent = "", 4000);
        });


        // --- Inicialização ---

        // Adiciona listeners para os filtros recarregarem a lista
        filtroMarca.addEventListener("change", setupListener);
        mostrarFeitos.addEventListener("change", setupListener);

        // Roda a verificação de 10 dias E inicializa a lista
        verificarEAtualizarPedidosAntigos().then(() => {
            setupListener(); // Carrega a lista principal
        });

    </script>
</body>
</html>
